package com.currency.currencyconversionservice.service;

import java.time.Instant;

import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import com.currency.currencyconversionservice.entity.CurrencyConverted;
import com.currency.currencyconversionservice.entity.CurrencyRate;


@Service
public class CurrencyServiceClass implements CurrencyService {

	@Override
	public CurrencyConverted getConversionRate(String from, String to, Integer quantity) {
		
		String accessKey="7fbb297eabc883c452ed9f45a5825d4b";

		// url for currency rate of 1 EUR to other currencies
		String url="http://data.fixer.io/api/latest?access_key=" + accessKey;
		ResponseEntity<CurrencyRate> currencyRate = new RestTemplate().getForEntity(url, CurrencyRate.class);	
		
		// got our response from the api wrt EUR
		
		// do our processing of {convertFrom} to {convertTo} currency conversion and with specified quantity.
		// then return the final result object of CurrencyConverted class.
		
		double rate=0.0;
		
		if(from.equals("EUR")) {  // no need to do processing default conversion is from EUR to other currencies.
			rate = currencyRate.getBody().getRates().get(to);
		}else {
			// convert rate according to the EUR
			double fromRate = currencyRate.getBody().getRates().get(from);
			double toRate = currencyRate.getBody().getRates().get(to);
			rate = toRate/fromRate;
		}
		
		//to convert unix timestamp into java instant

		long unixTimestamp = currencyRate.getBody().getTimestamp();
		Instant instant = Instant.ofEpochSecond(unixTimestamp);		
		
		CurrencyConverted converted = new CurrencyConverted(from, to, rate*quantity, rate,
											currencyRate.getBody().getDate() , instant.toString());
		
		return converted;
	}

}